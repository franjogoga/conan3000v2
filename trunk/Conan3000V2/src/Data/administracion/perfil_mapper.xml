<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Data.administracion.perfiles">
	<cache />
		
	<select id="searchPerfil" parameterType="IngSoft.administracion.bean.CriterioPerfilBeanData" resultType="IngSoft.administracion.bean.ResultadoPerfilBeanData">
		select PERFIL.IdPerfil as codigo, PERFIL.Nombre as nombre, PERFIL.Descripcion as descripcion
		from PERFIL
		where PERFIL.Nombre like #{nombre} and
			PERFIL.Descripcion like #{descripcion}
		order by 1 asc
	</select>
		
	<select id="getNextCodigo" resultType="java.lang.String">
		select max(IdPerfil) from PERFIL	
	</select>
	
	<insert id="insertPerfil" parameterType="IngSoft.administracion.bean.PerfilBeanData" flushCache="true">
		insert into PERFIL(IdPerfil, Nombre, Descripcion,Estado)
		values (#{codigo}, #{nombre}, #{descripcion},'Activo')
	</insert>
	
	<select id="getPerfil" parameterType="java.lang.String" resultType="IngSoft.administracion.bean.PerfilBeanData">
		select IdPerfil as codigo, Nombre as nombre, Descripcion as descripcion
		from PERFIL p
		where p.IdPerfil = #{codigo}
	</select>
	
	<delete id="deletePerfil" parameterType="IngSoft.administracion.bean.PerfilBeanData">
		delete from PERFIL 
		where IdPerfil = #{codigo}
	</delete>
	
	<update id="updatePerfil" parameterType="IngSoft.administracion.bean.PerfilBeanData">
		update PERFIL
		set Nombre = #{nombre}, Descripcion = #{descripcion}
		where IdPerfil = #{codigo}
	</update>
	
	<select id="getCasos" resultType="IngSoft.administracion.bean.CasosBeanData">
		select ACCIONxCASO_USO.IdCasoUso as codigoCaso, CASO_USO.Nombre as nombreCaso, ACCIONxCASO_USO.IdAccion as codigoAccion, ACCION.Nombre as nombreAccion 
		from ACCIONxCASO_USO, ACCION, CASO_USO
		where ACCION.IdAccion = ACCIONxCASO_USO.IdAccion and CASO_USO.IdCasoUso = ACCIONxCASO_USO.IdCasoUso order by 2;		
	</select>

	<insert id="insertAccionxcasoxperfil" parameterType="IngSoft.administracion.bean.PerfilBeanData" flushCache="true">
		insert into ACCIONxCASO_USOxPERFIL(IdPerfil, IdCasoUso, IdAccion)
		values (#{codigoPerfil}, #{codigoCaso}, #{codigoAccion})
	</insert>

	<select id="getAccionxcasoxperfil" parameterType="java.lang.String" resultType="IngSoft.administracion.bean.CasosBeanData">
		select ACCIONxCASO_USOxPERFIL.IdCasoUso as codigoCaso, CASO_USO.Nombre as nombreCaso, ACCIONxCASO_USOxPERFIL.IdAccion as codigoAccion, ACCION.Nombre as nombreAccion
		from ACCION, CASO_USO, ACCIONxCASO_USOxPERFIL 
		where ACCIONxCASO_USOxPERFIL.IdPerfil = #{codigoPerfil} and ACCION.IdAccion = ACCIONxCASO_USOxPERFIL.IdAccion 
			and CASO_USO.IdCasoUso = ACCIONxCASO_USOxPERFIL.IdCasoUso;	
	</select>
	
	<delete id="deletePerfilxaccionxcaso" parameterType="java.lang.String">
		delete from ACCIONxCASO_USOxPERFIL 
		where IdPerfil = #{codigo}
	</delete>
	
	<select id="searchPerfilOtros" parameterType="java.lang.String" resultType="IngSoft.administracion.bean.PerfilBeanData">
		SELECT p.IdPerfil as codigo
		FROM PERFIL p
		WHERE p.IdPerfil=#{codigo} AND
			  (p.IdPerfil IN ( 
					SELECT p.IdPerfil
					FROM PERFIL p, USUARIO u
					WHERE p.IdPerfil=u.IdPerfil
						  AND u.Estado!='Eliminado'))
	</select>
</mapper>